<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fidelity 401(k) Account Analysis</title>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .loading {
            display: none;
        }
        .loading.show {
            display: block;
        }
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 2s linear infinite;
            margin: 20px auto;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-100">
    <div class="container mx-auto p-4">
        <h1 class="text-3xl font-bold text-center text-blue-800 mb-4">
            Fidelity 401(k) Account Analysis
        </h1>
        <h3 class="text-lg text-center text-gray-600 mb-4">
            Upload your Fidelity 401(k) CSV file to analyze transactions
        </h3>
        
        <div class="flex justify-center mb-4">
            <form id="uploadForm" enctype="multipart/form-data">
                <input type="file" id="fileInput" name="file" accept=".csv" class="hidden">
                <button type="button" onclick="document.getElementById('fileInput').click()" 
                        class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded">
                    Upload CSV File
                </button>
            </form>
        </div>
        
        <div id="status" class="text-center text-gray-600 mb-4"></div>
        
        <div class="loading" id="loading">
            <div class="spinner"></div>
            <p class="text-center">Processing your file...</p>
        </div>
        
        <div id="results" style="display: none;">
            <div id="summary" class="bg-white p-6 rounded-lg shadow-md mb-8">
                <h2 class="text-2xl font-bold mb-4">Summary Metrics</h2>
                <div id="summaryContent"></div>
            </div>
            
            <div id="barChart" class="bg-white p-6 rounded-lg shadow-md mb-8">
                <div id="barChartDiv"></div>
            </div>
            
            <div id="lineChart" class="bg-white p-6 rounded-lg shadow-md mb-8">
                <div id="lineChartDiv"></div>
            </div>
            
            <div id="pieChart" class="bg-white p-6 rounded-lg shadow-md mb-8">
                <div id="pieChartDiv"></div>
            </div>
            
            <div id="dataTable" class="bg-white p-6 rounded-lg shadow-md mb-8">
                <h2 class="text-2xl font-bold mb-4">Transaction Data</h2>
                <div class="overflow-x-auto">
                    <table id="transactionTable" class="min-w-full table-auto">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-4 py-2 text-left">Date</th>
                                <th class="px-4 py-2 text-left">Investment</th>
                                <th class="px-4 py-2 text-left">Transaction Type</th>
                                <th class="px-4 py-2 text-right">Shares/Unit</th>
                                <th class="px-4 py-2 text-right">Amount ($)</th>
                            </tr>
                        </thead>
                        <tbody id="tableBody">
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script>
        document.getElementById('fileInput').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                uploadFile(file);
            }
        });

        function uploadFile(file) {
            const formData = new FormData();
            formData.append('file', file);
            
            document.getElementById('loading').classList.add('show');
            document.getElementById('status').textContent = '';
            document.getElementById('results').style.display = 'none';
            
            fetch('/upload', {
                method: 'POST',
                body: formData
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.text();
            })
            .then(text => {
                try {
                    const data = JSON.parse(text);
                    document.getElementById('loading').classList.remove('show');
                    
                    if (data.success) {
                        document.getElementById('status').textContent = 'File uploaded successfully!';
                        document.getElementById('status').className = 'text-center text-green-600 mb-4';
                        displayResults(data);
                    } else {
                        document.getElementById('status').textContent = data.error || 'Error processing file';
                        document.getElementById('status').className = 'text-center text-red-600 mb-4';
                    }
                } catch (e) {
                    document.getElementById('loading').classList.remove('show');
                    console.error('Response text:', text);
                    document.getElementById('status').textContent = 'Error: Server returned invalid response. Check console for details.';
                    document.getElementById('status').className = 'text-center text-red-600 mb-4';
                }
            })
            .catch(error => {
                document.getElementById('loading').classList.remove('show');
                document.getElementById('status').textContent = 'Error uploading file: ' + error.message;
                document.getElementById('status').className = 'text-center text-red-600 mb-4';
            });
        }

        function displayResults(data) {
            // Display summary
            displaySummary(data.summary);
            
            // Display charts
            if (data.bar_chart) {
                try {
                    Plotly.newPlot('barChartDiv', JSON.parse(data.bar_chart));
                } catch (e) {
                    console.error('Error parsing bar chart data:', e);
                    document.getElementById('barChartDiv').innerHTML = '<p class="text-center text-gray-500">Unable to display bar chart</p>';
                }
            } else {
                document.getElementById('barChartDiv').innerHTML = '<p class="text-center text-gray-500">No data available for bar chart</p>';
            }
            
            if (data.line_chart) {
                try {
                    Plotly.newPlot('lineChartDiv', JSON.parse(data.line_chart));
                } catch (e) {
                    console.error('Error parsing line chart data:', e);
                    document.getElementById('lineChartDiv').innerHTML = '<p class="text-center text-gray-500">Unable to display line chart</p>';
                }
            } else {
                document.getElementById('lineChartDiv').innerHTML = '<p class="text-center text-gray-500">No data available for line chart</p>';
            }
            
            if (data.pie_chart) {
                try {
                    Plotly.newPlot('pieChartDiv', JSON.parse(data.pie_chart));
                } catch (e) {
                    console.error('Error parsing pie chart data:', e);
                    document.getElementById('pieChartDiv').innerHTML = '<p class="text-center text-gray-500">Unable to display pie chart</p>';
                }
            } else {
                document.getElementById('pieChartDiv').innerHTML = '<p class="text-center text-gray-500">No data available for pie chart</p>';
            }
            
            // Display table
            displayTable(data.table_data);
            
            document.getElementById('results').style.display = 'block';
        }

        function displaySummary(summary) {
            let html = '';
            
            summary.investments.forEach(investment => {
                html += `<div class="mb-4">`;
                html += `<h3 class="text-lg font-semibold text-blue-700">${investment.investment}</h3>`;
                investment.transactions.forEach(transaction => {
                    html += `<p class="ml-4">â€¢ ${transaction.type}: $${transaction.amount}</p>`;
                });
                html += `<p class="ml-4 font-semibold">Total for ${investment.investment}: $${investment.total}</p>`;
                html += `</div>`;
            });
            
            html += `<div class="mt-6 p-4 bg-blue-50 rounded">`;
            html += `<h3 class="text-xl font-bold text-blue-800">Net Account Change: $${summary.net_change}</h3>`;
            html += `</div>`;
            
            document.getElementById('summaryContent').innerHTML = html;
        }

        function displayTable(tableData) {
            const tbody = document.getElementById('tableBody');
            tbody.innerHTML = '';
            
            tableData.forEach(row => {
                const tr = document.createElement('tr');
                tr.className = 'border-b hover:bg-gray-50';
                
                tr.innerHTML = `
                    <td class="px-4 py-2">${row.Date || ''}</td>
                    <td class="px-4 py-2">${row.Investment || ''}</td>
                    <td class="px-4 py-2">${row['Transaction Type'] || ''}</td>
                    <td class="px-4 py-2 text-right">${row['Shares/Unit'] ? row['Shares/Unit'].toFixed(3) : ''}</td>
                    <td class="px-4 py-2 text-right">${row['Amount ($)'] ? '$' + row['Amount ($)'].toFixed(2) : ''}</td>
                `;
                
                tbody.appendChild(tr);
            });
        }
    </script>
</body>
</html>
